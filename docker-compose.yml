# =============================================================================
# Docker Compose - FastAPI Boilerplate Development Environment
#
# USAGE:
#   docker-compose up -d           # Start all services
#   docker-compose down            # Stop all services
#   docker-compose logs -f api     # View API logs
#   docker-compose --profile tools up -d  # Start with PgAdmin & Mongo Express
#
# DATABASE OPTIONS:
#   To remove PostgreSQL: Delete the 'postgres' service and its volume
#   To remove MongoDB: Delete the 'mongodb' service and its volume
# =============================================================================
version: '3.8'

services:
  # ===========================================================================
  # PostgreSQL - Relational Database
  # NOTE: Remove this service if not using PostgreSQL
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: app_postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-app_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-app_db}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_postgres.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app_user -d app_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # MongoDB - Document Database
  # NOTE: Remove this service if not using MongoDB
  # ===========================================================================
  mongodb:
    image: mongo:7
    container_name: app_mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-app_admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-app_mongo_password}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-app_db}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./scripts/init_mongo.js:/docker-entrypoint-initdb.d/init.js:ro
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # API - FastAPI Application
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: app_api
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    environment:
      # PostgreSQL Configuration
      POSTGRES_SERVER: ${POSTGRES_SERVER:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-app_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-app_db}

      # MongoDB Configuration
      MONGODB_URL: ${MONGODB_URL:-mongodb://app_admin:app_mongo_password@mongodb:27017/app_db?authSource=admin}
      MONGODB_DB: ${MONGODB_DB:-app_db}

      # Security - CHANGE IN PRODUCTION!
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production-use-openssl-rand-hex-32}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}

      # Application
      DEBUG: ${DEBUG:-"true"}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      CORS_ORIGINS: ${CORS_ORIGINS:-'["http://localhost:3000"]'}

      # Telegram Alerts (optional)
      TELEGRAM_ALERTS_ENABLED: ${TELEGRAM_ALERTS_ENABLED:-false}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}

    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - /app/.venv  # Exclude virtual environment from mount
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - app_network

  # ===========================================================================
  # PgAdmin - PostgreSQL GUI (optional, use --profile tools to start)
  # ===========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: app_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@local.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: ${PGADMIN_CONFIG_SERVER_MODE:-False}
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - app_network
    profiles:
      - tools

  # ===========================================================================
  # Mongo Express - MongoDB GUI (optional, use --profile tools to start)
  # ===========================================================================
  mongo-express:
    image: mongo-express:latest
    container_name: app_mongo_express
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${ME_CONFIG_MONGODB_ADMINUSERNAME:-app_admin}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${ME_CONFIG_MONGODB_ADMINPASSWORD:-app_mongo_password}
      ME_CONFIG_MONGODB_URL: ${ME_CONFIG_MONGODB_URL:-mongodb://app_admin:app_mongo_password@mongodb:27017/}
      ME_CONFIG_BASICAUTH_USERNAME: ${ME_CONFIG_BASICAUTH_USERNAME:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${ME_CONFIG_BASICAUTH_PASSWORD:-admin}
    ports:
      - "8081:8081"
    depends_on:
      - mongodb
    networks:
      - app_network
    profiles:
      - tools

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
  mongodb_data:
    driver: local
  pgadmin_data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  app_network:
    driver: bridge
